# OnlineJudge äº‘ç«¯é‡æ–°éƒ¨ç½²æŒ‡å—

> æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨æœ¬åœ°ä¿®æ”¹ä»£ç åï¼Œå°†æ›´æ–°éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨

---

## ğŸ“‹ ç›®å½•

1. [å‰ç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²](#å‰ç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²)
2. [åç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²](#åç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²)
3. [å‰åç«¯åŒæ—¶ä¿®æ”¹](#å‰åç«¯åŒæ—¶ä¿®æ”¹)
4. [å¿«é€Ÿéƒ¨ç½²è„šæœ¬](#å¿«é€Ÿéƒ¨ç½²è„šæœ¬)
5. [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## å‰ç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²

### é€‚ç”¨åœºæ™¯
- ä¿®æ”¹äº† Vue ç»„ä»¶ (`.vue` æ–‡ä»¶)
- ä¿®æ”¹äº†å‰ç«¯æ ·å¼ (`.css`, `.scss`)
- ä¿®æ”¹äº†å‰ç«¯ JavaScript ä»£ç 
- ä¿®æ”¹äº†å‰ç«¯è·¯ç”±æˆ–é…ç½®

### éƒ¨ç½²æ­¥éª¤

#### 1. æœ¬åœ°æ„å»ºå‰ç«¯

```bash
# åœ¨ WSL æœ¬åœ°é¡¹ç›®ç›®å½•
cd /mnt/c/Users/wyb/Desktop/code/se/OnlineJudge/frontend

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆNode 22 éœ€è¦ï¼‰
export NODE_OPTIONS=--openssl-legacy-provider

# å®‰è£…ä¾èµ–ï¼ˆé¦–æ¬¡æˆ–ä¾èµ–å˜åŠ¨æ—¶ï¼‰
yarn install --ignore-scripts

# å…ˆæ„å»º DLLï¼Œå†æ„å»ºä¸»åŒ…ï¼ˆé¡ºåºä¸èƒ½åï¼‰
yarn build:dll
yarn build

# éªŒè¯æ„å»ºæˆåŠŸ
ls -la dist/
```

**é¢„æœŸè¾“å‡º**ï¼š
```
dist/
â”œâ”€â”€ admin/       # ç®¡ç†åå°
â”œâ”€â”€ index.html   # ä¸»é¡µ
â””â”€â”€ static/      # é™æ€èµ„æº
```

> âš ï¸ è‹¥ä»…æ‰§è¡Œ `yarn build` è€Œæœªå…ˆæ‰§è¡Œ `yarn build:dll`ï¼Œæµè§ˆå™¨ä¼šæŠ¥ `vendor_xxx_dll is not defined` å¹¶å¡åœ¨åŠ è½½ç•Œé¢ã€‚

#### 2. æ‰“åŒ…å‰ç«¯æ–‡ä»¶

```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# æ‰“åŒ…å‰ç«¯æ„å»ºç»“æœ
tar -czf /tmp/frontend-dist.tar.gz frontend/dist/
```

#### 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -i ~/.ssh/aliyun.pem /tmp/frontend-dist.tar.gz root@39.103.63.219:/tmp/

# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹å¹¶æ›¿æ¢
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
rm -rf frontend/dist
mkdir -p frontend
cd frontend
tar -xzf /tmp/frontend-dist.tar.gz
rm /tmp/frontend-dist.tar.gz
echo "âœ… å‰ç«¯æ–‡ä»¶å·²æ›´æ–°"
EOF
```

#### 4. é‡å¯åç«¯å®¹å™¨

```bash
# é‡å¯ backend å®¹å™¨ä»¥åŠ è½½æ–°å‰ç«¯
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
docker compose restart oj-backend
echo "âœ… æœåŠ¡å·²é‡å¯"

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 5

# éªŒè¯æœåŠ¡çŠ¶æ€
docker compose ps | grep oj-backend
EOF
```

#### 5. éªŒè¯æ›´æ–°

åœ¨æµè§ˆå™¨è®¿é—®ï¼š`http://39.103.63.219`

æŒ‰ `Ctrl + F5` å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ç¼“å­˜ã€‚

---

## åç«¯ä¿®æ”¹é‡æ–°éƒ¨ç½²

### é€‚ç”¨åœºæ™¯
- ä¿®æ”¹äº† Python ä»£ç  (`.py` æ–‡ä»¶)
- ä¿®æ”¹äº†æ•°æ®åº“æ¨¡å‹ (models)
- ä¿®æ”¹äº† API æ¥å£
- ä¿®æ”¹äº†é…ç½®æ–‡ä»¶

### éƒ¨ç½²æ­¥éª¤

#### 1. æäº¤ä»£ç åˆ° Gitï¼ˆæ¨èï¼‰

```bash
# åœ¨æœ¬åœ°é¡¹ç›®æ ¹ç›®å½•
cd /mnt/c/Users/wyb/Desktop/code/se/OnlineJudge

# æäº¤ä¿®æ”¹
git add .
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"
git push
```

#### 2. åœ¨æœåŠ¡å™¨ä¸Šæ‹‰å–ä»£ç 

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
git pull
echo "âœ… ä»£ç å·²æ›´æ–°"
EOF
```

**å¦‚æœ Git ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¸Šä¼ æ–¹å¼**ï¼š

```bash
# æ‰“åŒ…åç«¯ä»£ç ï¼ˆæ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼‰
tar -czf /tmp/backend-code.tar.gz \
  --exclude='frontend/node_modules' \
  --exclude='frontend/dist' \
  --exclude='data' \
  --exclude='.git' \
  account/ announcement/ conf/ contest/ \
  judge/ oj/ options/ problem/ submission/ \
  utils/ manage.py requirements.txt

# ä¸Šä¼ 
scp -i ~/.ssh/aliyun.pem /tmp/backend-code.tar.gz root@39.103.63.219:/tmp/

# è§£å‹
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
tar -xzf /tmp/backend-code.tar.gz
rm /tmp/backend-code.tar.gz
echo "âœ… åç«¯ä»£ç å·²æ›´æ–°"
EOF
```

#### 3. é‡æ–°æ„å»º Docker é•œåƒ

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge

echo "å¼€å§‹æ„å»º Docker é•œåƒ..."
docker build -t my-onlinejudge-backend:latest .

if [ $? -eq 0 ]; then
  echo "âœ… é•œåƒæ„å»ºæˆåŠŸ"
else
  echo "âŒ é•œåƒæ„å»ºå¤±è´¥"
  exit 1
fi
EOF
```

**æ³¨æ„**ï¼šæ„å»ºå¯èƒ½éœ€è¦ 10-15 åˆ†é’Ÿã€‚

#### 4. è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœä¿®æ”¹äº† modelsï¼‰

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge

# ç”Ÿæˆè¿ç§»æ–‡ä»¶
docker exec oj-backend python manage.py makemigrations

# æ‰§è¡Œè¿ç§»
docker exec oj-backend python manage.py migrate

echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
EOF
```

#### 5. é‡å¯æœåŠ¡

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge

# åœæ­¢æ—§å®¹å™¨
docker compose down

# å¯åŠ¨æ–°å®¹å™¨
docker compose up -d

# ç­‰å¾…å¯åŠ¨
sleep 30

# æ£€æŸ¥çŠ¶æ€
docker compose ps

echo "âœ… æœåŠ¡é‡å¯å®Œæˆ"
EOF
```

#### 6. éªŒè¯æ›´æ–°

```bash
# æ£€æŸ¥åç«¯æ—¥å¿—
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 'docker logs oj-backend --tail 20'

# æµ‹è¯• API
curl http://39.103.63.219/api/website
```

---

## å‰åç«¯åŒæ—¶ä¿®æ”¹

### å®Œæ•´éƒ¨ç½²æµç¨‹

#### æ­¥éª¤ 1: æœ¬åœ°å‡†å¤‡

```bash
# 1. æ„å»ºå‰ç«¯
cd /mnt/c/Users/wyb/Desktop/code/se/OnlineJudge/frontend
export NODE_OPTIONS=--openssl-legacy-provider
yarn install --ignore-scripts
yarn build:dll
yarn build

# 2. è¿”å›æ ¹ç›®å½•
cd ..

# 3. æäº¤ä»£ç ï¼ˆæ¨èï¼‰
git add .
git commit -m "æè¿°ä½ çš„ä¿®æ”¹"
git push
```

#### æ­¥éª¤ 2: æ‰“åŒ…å¹¶ä¸Šä¼ 

```bash
# æ‰“åŒ…æ•´ä¸ªé¡¹ç›®ï¼ˆå¦‚æœ Git ä¸å¯ç”¨ï¼‰
tar -czf /tmp/onlinejudge-update.tar.gz \
  --exclude='frontend/node_modules' \
  --exclude='node_modules' \
  --exclude='data/backend' \
  --exclude='data/judge_server' \
  --exclude='data/redis' \
  --exclude='.git' \
  --exclude='.claude' \
  .

# ä¸Šä¼ 
scp -i ~/.ssh/aliyun.pem /tmp/onlinejudge-update.tar.gz root@39.103.63.219:/tmp/
```

#### æ­¥éª¤ 3: æœåŠ¡å™¨ç«¯éƒ¨ç½²

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
set -e

cd /root/OnlineJudge

echo "=== 1. åœæ­¢æœåŠ¡ ==="
docker compose down

echo ""
echo "=== 2. æ›´æ–°ä»£ç  ==="
# å¦‚æœä½¿ç”¨ Git
git pull

# å¦‚æœä½¿ç”¨ä¸Šä¼ 
# tar -xzf /tmp/onlinejudge-update.tar.gz
# rm /tmp/onlinejudge-update.tar.gz

echo ""
echo "=== 3. é‡æ–°æ„å»ºé•œåƒ ==="
docker build -t my-onlinejudge-backend:latest .

echo ""
echo "=== 4. å¯åŠ¨æœåŠ¡ ==="
docker compose up -d

echo ""
echo "=== 5. ç­‰å¾…æœåŠ¡å¯åŠ¨ ==="
sleep 30

echo ""
echo "=== 6. æ£€æŸ¥æœåŠ¡çŠ¶æ€ ==="
docker compose ps

echo ""
echo "=== 7. æŸ¥çœ‹æ—¥å¿— ==="
docker logs oj-backend --tail 10

echo ""
echo "âœ… éƒ¨ç½²å®Œæˆï¼"
EOF
```

---

## å¿«é€Ÿéƒ¨ç½²è„šæœ¬

### åˆ›å»ºæœ¬åœ°éƒ¨ç½²è„šæœ¬

åˆ›å»ºæ–‡ä»¶ `redeploy.sh`ï¼š

```bash
#!/bin/bash
# OnlineJudge å¿«é€Ÿé‡æ–°éƒ¨ç½²è„šæœ¬

set -e

SERVER_IP="39.103.63.219"
SSH_KEY="~/.ssh/aliyun.pem"

echo "ğŸš€ å¼€å§‹é‡æ–°éƒ¨ç½² OnlineJudge"
echo ""

# 1. æ„å»ºå‰ç«¯
echo "ğŸ“¦ æ­¥éª¤ 1/5: æ„å»ºå‰ç«¯..."
cd frontend
export NODE_OPTIONS=--openssl-legacy-provider
yarn build
cd ..

# 2. æ‰“åŒ…é¡¹ç›®
echo "ğŸ“¦ æ­¥éª¤ 2/5: æ‰“åŒ…é¡¹ç›®..."
tar -czf /tmp/oj-update.tar.gz \
  --exclude='frontend/node_modules' \
  --exclude='node_modules' \
  --exclude='data' \
  --exclude='.git' \
  --exclude='.claude' \
  .

# 3. ä¸Šä¼ åˆ°æœåŠ¡å™¨
echo "ğŸ“¤ æ­¥éª¤ 3/5: ä¸Šä¼ åˆ°æœåŠ¡å™¨..."
scp -i $SSH_KEY /tmp/oj-update.tar.gz root@$SERVER_IP:/tmp/

# 4. æœåŠ¡å™¨ç«¯éƒ¨ç½²
echo "ğŸ”§ æ­¥éª¤ 4/5: æœåŠ¡å™¨ç«¯éƒ¨ç½²..."
ssh -i $SSH_KEY root@$SERVER_IP << 'ENDSSH'
cd /root/OnlineJudge
docker compose down
tar -xzf /tmp/oj-update.tar.gz
rm /tmp/oj-update.tar.gz
docker build -t my-onlinejudge-backend:latest .
docker compose up -d
sleep 20
docker compose ps
ENDSSH

# 5. æµ‹è¯•è®¿é—®
echo "âœ… æ­¥éª¤ 5/5: æµ‹è¯•è®¿é—®..."
sleep 5
curl -s -o /dev/null -w "HTTP: %{http_code}\n" http://$SERVER_IP

echo ""
echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼è®¿é—®: http://$SERVER_IP"
```

**ä½¿ç”¨æ–¹æ³•**ï¼š

```bash
# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x redeploy.sh

# è¿è¡Œéƒ¨ç½²
./redeploy.sh
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: å‰ç«¯ä¿®æ”¹æœªç”Ÿæ•ˆ

**åŸå› **ï¼šæµè§ˆå™¨ç¼“å­˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl + F5ï¼‰
# 2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# 3. ä½¿ç”¨éšèº«æ¨¡å¼è®¿é—®
```

### é—®é¢˜ 2: åç«¯å®¹å™¨å¯åŠ¨å¤±è´¥

**æ£€æŸ¥æ—¥å¿—**ï¼š
```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 'docker logs oj-backend --tail 50'
```

**å¸¸è§åŸå› **ï¼š
- Python è¯­æ³•é”™è¯¯
- ç¼ºå°‘ä¾èµ–åŒ…
- æ•°æ®åº“è¿ç§»æœªæ‰§è¡Œ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è¿›å…¥å®¹å™¨è°ƒè¯•
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219
docker exec -it oj-backend sh
python manage.py check
```

### é—®é¢˜ 3: Docker é•œåƒæ„å»ºå¤±è´¥

**æŸ¥çœ‹å®Œæ•´æ„å»ºæ—¥å¿—**ï¼š
```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
docker build -t my-onlinejudge-backend:latest . 2>&1 | tee build.log
EOF
```

### é—®é¢˜ 4: æ•°æ®åº“è¿ç§»å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
docker exec oj-backend python manage.py showmigrations
docker exec oj-backend python manage.py migrate --fake-initial
EOF
```

### é—®é¢˜ 5: ç«¯å£å†²çª

**æ£€æŸ¥ç«¯å£å ç”¨**ï¼š
```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 'netstat -tulpn | grep :80'
```

**é‡å¯ Docker**ï¼š
```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
docker compose down
docker compose up -d
EOF
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²åç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] æ‰€æœ‰å®¹å™¨çŠ¶æ€ä¸º `Up (healthy)`
- [ ] å‰ç«¯é¡µé¢å¯ä»¥æ­£å¸¸è®¿é—®
- [ ] ç®¡ç†åå°å¯ä»¥ç™»å½•
- [ ] API æ¥å£æ­£å¸¸å“åº”
- [ ] åˆ¤é¢˜åŠŸèƒ½æ­£å¸¸ï¼ˆæäº¤ä»£ç æµ‹è¯•ï¼‰
- [ ] æŸ¥çœ‹æ—¥å¿—æ— é”™è¯¯ä¿¡æ¯

---

## ğŸ”„ å›æ»šæ“ä½œ

å¦‚æœéƒ¨ç½²åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

### æ–¹æ³• 1: ä½¿ç”¨ Git å›æ»š

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
cd /root/OnlineJudge
git log --oneline -5           # æŸ¥çœ‹æœ€è¿‘æäº¤
git reset --hard <commit-id>   # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
docker compose down
docker build -t my-onlinejudge-backend:latest .
docker compose up -d
EOF
```

### æ–¹æ³• 2: ä½¿ç”¨ Docker é•œåƒå›æ»š

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219 << 'EOF'
docker images | grep onlinejudge   # æŸ¥çœ‹å†å²é•œåƒ
docker tag <old-image-id> my-onlinejudge-backend:latest
docker compose up -d
EOF
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ CI/CD è‡ªåŠ¨éƒ¨ç½²

å¯ä»¥é…ç½® GitHub Actions è‡ªåŠ¨éƒ¨ç½²ï¼š

```yaml
# .github/workflows/deploy.yml
name: Deploy to Aliyun

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy
        run: |
          # éƒ¨ç½²è„šæœ¬
```

### 2. å¢é‡æ›´æ–°

åªä¸Šä¼ ä¿®æ”¹çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªé¡¹ç›®ã€‚

### 3. ä½¿ç”¨ç§æœ‰ Docker Registry

å°†é•œåƒæ¨é€åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ï¼ŒåŠ å¿«éƒ¨ç½²é€Ÿåº¦ã€‚

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

- æŸ¥çœ‹æ—¥å¿—ï¼š`docker logs oj-backend`
- æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ï¼š`docker compose ps`
- æŸ¥çœ‹èµ„æºä½¿ç”¨ï¼š`docker stats`

---

---

## é™„å½•ï¼šåœ¨æœåŠ¡å™¨ç›´æ¥æ„å»ºå‰ç«¯

è‹¥æœ¬åœ°ç½‘ç»œå—é™æˆ– CI/CD ç›´æ¥æŠŠä»£ç æ‰“åŒ…ä¸Šä¼ ï¼Œå¯åœ¨æœåŠ¡å™¨ `/root/OnlineJudge/frontend` å†…æ„å»ºï¼š

```bash
ssh -i ~/.ssh/aliyun.pem root@39.103.63.219
cd /root/OnlineJudge/frontend

# é¿å… npm ç¼“å­˜æƒé™é—®é¢˜
chown -R $(whoami) ~/.npm

export NODE_OPTIONS=--openssl-legacy-provider

# ä»…é¦–æ¬¡éœ€è¦ï¼Œæˆ–ä¾èµ–å‡çº§åæ‰§è¡Œ
npm install --legacy-peer-deps --ignore-scripts

npm run build:dll
npm run build
```

- æœ¬ä»“åº“ `frontend/config/dev.env.js` å·²å¢åŠ å…œåº•é€»è¾‘ï¼›è‹¥éƒ¨ç½²åŒ…é‡Œæ²¡æœ‰ `.git`ï¼Œ`git rev-parse` å¤±è´¥ä¼šè‡ªåŠ¨é€€åŒ–ä¸º `"local"`ã€‚è‹¥ä½ ä½¿ç”¨æ—§ç‰ˆæœ¬ä»£ç ï¼Œè¯·æ‰‹åŠ¨æ›´æ–°è¯¥æ–‡ä»¶ã€‚
- æ„å»ºå®Œæ¯•åŠ¡å¿…ç¡®è®¤ `/root/OnlineJudge/frontend/dist` éç©ºï¼Œå† `docker compose restart oj-backend`ã€‚

---

**æœ€åæ›´æ–°**: 2025-11-18  
**é€‚ç”¨ç‰ˆæœ¬**: OnlineJudge 2.0
