# 清理重复判题服务器记录

## 问题说明

当判题服务器容器被重新创建时，可能会在数据库中创建多个相同hostname的记录，导致管理后台显示多个Abnormal状态的判题服务器。

## 快速清理命令

### 删除所有重复的判题服务器记录（只保留最新的）

```bash
docker exec oj-backend python manage.py shell -c "
from conf.models import JudgeServer
from django.db.models import Count

# 查找所有有重复hostname的记录
duplicates = JudgeServer.objects.values('hostname').annotate(
    count=Count('hostname')
).filter(count__gt=1)

for dup in duplicates:
    hostname = dup['hostname']
    # 获取该hostname的所有记录，按创建时间排序
    servers = JudgeServer.objects.filter(hostname=hostname).order_by('-create_time')
    # 删除除最新记录外的所有记录
    if servers.count() > 1:
        deleted = servers[1:].delete()
        print(f'Deleted {deleted[0]} duplicate records for hostname: {hostname}')

print('Cleanup completed')
"
```

### 删除所有Abnormal状态的记录

```bash
docker exec oj-backend python manage.py shell -c "
from conf.models import JudgeServer
from django.utils import timezone
from datetime import timedelta

# 删除超过10分钟未心跳的记录
old_time = timezone.now() - timedelta(minutes=10)
deleted = JudgeServer.objects.filter(last_heartbeat__lt=old_time).delete()
print(f'Deleted {deleted[0]} old judge server records')
"
```

### 查看所有判题服务器记录

```bash
docker exec oj-backend python manage.py shell -c "
from conf.models import JudgeServer
servers = JudgeServer.objects.all()
print(f'Total servers: {servers.count()}')
for s in servers:
    print(f'  ID: {s.id}')
    print(f'    Hostname: {s.hostname}')
    print(f'    Status: {s.status}')
    print(f'    Service URL: {s.service_url}')
    print(f'    Last Heartbeat: {s.last_heartbeat}')
    print(f'    Create Time: {s.create_time}')
    print()
"
```

## 预防措施

代码已经更新，心跳API现在会自动：
1. 检测相同hostname的多个记录
2. 自动删除旧的记录，只保留最新的
3. 防止创建重复记录

## 手动清理步骤

如果管理后台显示多个Abnormal的判题服务器：

1. **登录管理后台**
   - 访问：`http://YOUR_SERVER_IP/admin`
   - 进入 "Judge Server" 页面

2. **删除旧记录**
   - 找到所有Abnormal状态的服务器
   - 点击删除按钮删除旧记录
   - 只保留Normal状态的服务器

3. **或者使用命令行清理**
   - 使用上面的清理命令自动删除重复记录

## 验证修复

清理后，检查是否只有一个Normal状态的判题服务器：

```bash
docker exec oj-backend python manage.py shell -c "
from conf.models import JudgeServer
servers = JudgeServer.objects.all()
normal_servers = [s for s in servers if s.status == 'normal']
print(f'Total servers: {servers.count()}')
print(f'Normal servers: {len(normal_servers)}')
print(f'Abnormal servers: {servers.count() - len(normal_servers)}')
"
```

---

**最后更新**：2024年

